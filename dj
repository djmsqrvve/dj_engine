#!/bin/bash

# DJ Engine Helper Script
# Usage: ./dj [command] [args]

VERBOSE=0
ARGS=()

# Process arguments to detect verbose flag
for arg in "$@"; do
    if [[ "$arg" == "-v" || "$arg" == "--verbose" ]]; then
        VERBOSE=1
    else
        ARGS+=("$arg")
    fi
done

if [ $VERBOSE -eq 1 ]; then
    export RUST_LOG=debug
    echo "üîç Verbose mode enabled (RUST_LOG=debug)"
fi

# Reset positional parameters to the filtered arguments
set -- "${ARGS[@]}"

COMMAND=$1
SHIFT_ARGS="${@:2}"

case $COMMAND in
    "e" | "editor")
        echo "üöÄ Starting DJ Engine Editor..."
        # Run the engine's main binary (editor mode)
        cargo run -p dj_engine --bin dj_engine -- --editor $SHIFT_ARGS
        ;;
    "d" | "game")
        # Check if a game package is specified
        if [ -n "$2" ]; then
            echo "üéÆ Starting game: $2..."
            cargo run -p "$2" -- ${@:3}
        else
            echo "‚ùå No game specified. Usage: ./dj d <game_name>"
            echo "   Available games (check games/dev/):"
            ls -1 games/dev/ 2>/dev/null || echo "   No games found"
        fi
        ;;
    "t" | "test")
        echo "üß™ Running DJ Engine Tests..."
        cargo test --workspace $SHIFT_ARGS
        ;;
    "m" | "minimal")
        echo "üü• Starting Minimal Visibility Test..."
        cargo run -p dj_engine --bin minimal
        ;;
    "g" | "gen")
        echo "üõ† Running Asset Generator..."
        cargo run -p asset_generator -- $SHIFT_ARGS
        ;;
    "fmt" | "format")
        echo "‚ú® Formatting code..."
        cargo fmt --all
        ;;
    "lint" | "clippy")
        echo "üîé Running Clippy linter..."
        cargo clippy --workspace -- -W clippy::all
        ;;
    "doc" | "docs")
        echo "üìö Generating documentation..."
        cargo doc --workspace --no-deps $SHIFT_ARGS
        echo "üìñ Open: target/doc/dj_engine/index.html"
        ;;
    "check" | "c")
        echo "‚úÖ Checking code..."
        cargo check --workspace
        ;;
    "build" | "b")
        echo "üî® Building release..."
        cargo build --release --workspace
        ;;
    "clean")
        echo "üßπ Cleaning build artifacts..."
        cargo clean
        ;;
    *)
        echo "DJ Engine CLI"
        echo "Usage: ./dj [command] [flags]"
        echo ""
        echo "Development:"
        echo "  e, editor    - Launch the DJ Engine Editor"
        echo "  d, helix     - Run the Helix Before The Fracture game"
        echo "  m, minimal   - Run minimal visibility test"
        echo ""
        echo "Testing & Quality:"
        echo "  t, test      - Run all workspace tests"
        echo "  c, check     - Check code compiles"
        echo "  fmt, format  - Format code (cargo fmt)"
        echo "  lint, clippy - Run Clippy linter"
        echo ""
        echo "Build:"
        echo "  b, build     - Build release binaries"
        echo "  doc, docs    - Generate documentation"
        echo "  clean        - Clean build artifacts"
        echo ""
        echo "Tools:"
        echo "  g, gen       - Run asset generator"
        echo ""
        echo "Flags:"
        echo "  -v, --verbose - Enable debug logging"
        echo ""
        ;;
esac
