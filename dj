#!/bin/bash

# DJ Engine Helper Script
# Usage: ./dj [command] [args]

VERBOSE=0
LOG_FILE=""
ARGS=()

# Process arguments to detect verbose and log flags
for arg in "$@"; do
    if [[ "$arg" == "-v" || "$arg" == "--verbose" ]]; then
        VERBOSE=1
    elif [[ "$arg" == "-verbose.log" ]]; then
        VERBOSE=1
        LOG_FILE="verbose.log"
    else
        ARGS+=("$arg")
    fi
done

if [ $VERBOSE -eq 1 ]; then
    export RUST_LOG=${RUST_LOG:-debug}
    echo "üîç Verbose mode enabled (RUST_LOG=$RUST_LOG)"
fi

if [ -n "$LOG_FILE" ]; then
    echo "üìÑ Logging output to $LOG_FILE"
fi

# Reset positional parameters to the filtered arguments
set -- "${ARGS[@]}"

COMMAND=$1
SHIFT_ARGS="${@:2}"

# Helper function to run commands with optional logging
run_cmd() {
    if [ -n "$LOG_FILE" ]; then
        "$@" 2>&1 | tee "$LOG_FILE"
    else
        "$@"
    fi
}

case $COMMAND in
    "e" | "editor")
        echo "üöÄ Starting DJ Engine Editor..."
        run_cmd cargo run -p dj_engine --bin dj_engine -- --editor $SHIFT_ARGS
        ;;
    "d" | "game")
        if [ -n "$2" ]; then
            echo "üéÆ Starting game: $2..."
            run_cmd cargo run -p "$2" -- ${@:3}
        else
            echo "‚ùå No game specified. Usage: ./dj d <game_name>"
            ls -1 games/dev/ 2>/dev/null || echo "   No games found"
        fi
        ;;
    "t" | "test")
        echo "üß™ Running DJ Engine Tests..."
        export RUST_LOG=${RUST_LOG:-info}
        TEST_OPTS=""
        if [ $VERBOSE -eq 1 ]; then
            # Check if user already provided --
            if [[ "$SHIFT_ARGS" == *"--"* ]]; then
                TEST_OPTS="$SHIFT_ARGS --nocapture"
            else
                TEST_OPTS="$SHIFT_ARGS -- --nocapture"
            fi
        else
            TEST_OPTS="$SHIFT_ARGS"
        fi
        run_cmd cargo test --workspace $TEST_OPTS
        ;;
    "m" | "minimal")
        echo "üü• Starting Minimal Visibility Test..."
        run_cmd cargo run -p dj_engine --bin minimal
        ;;
    "g" | "gen")
        echo "üõ† Running Asset Generator..."
        run_cmd cargo run -p asset_generator -- $SHIFT_ARGS
        ;;
    "fmt" | "format")
        echo "‚ú® Formatting code..."
        run_cmd cargo fmt --all
        ;;
    "lint" | "clippy")
        echo "üîé Running Clippy linter..."
        run_cmd cargo clippy --workspace -- -W clippy::all
        ;;
    "doc" | "docs")
        echo "üìö Generating documentation..."
        run_cmd cargo doc --workspace --no-deps $SHIFT_ARGS
        echo "üìñ Open: target/doc/dj_engine/index.html"
        ;;
    "check" | "c")
        echo "‚úÖ Checking code..."
        run_cmd cargo check --workspace
        ;;
    "build" | "b")
        echo "üî® Building release..."
        run_cmd cargo build --release --workspace
        ;;
    "clean")
        echo "üßπ Cleaning build artifacts..."
        run_cmd cargo clean
        ;;
    *)
        echo "DJ Engine CLI"
        echo "Usage: ./dj [command] [flags]"
        echo ""
        echo "Development:"
        echo "  e, editor    - Launch the DJ Engine Editor"
        echo "  d, game      - Run a game package"
        echo "  m, minimal   - Run minimal visibility test"
        echo ""
        echo "Testing & Quality:"
        echo "  t, test      - Run all workspace tests"
        echo "  c, check     - Check code compiles"
        echo "  fmt, format  - Format code"
        echo "  lint, clippy - Run Clippy linter"
        echo ""
        echo "Build:"
        echo "  b, build     - Build release binaries"
        echo "  doc, docs    - Generate documentation"
        echo "  clean        - Clean build artifacts"
        echo ""
        echo "Tools:"
        echo "  g, gen       - Run asset generator"
        echo ""
        echo "Flags:"
        echo "  -v, --verbose - Enable debug logging + --nocapture for tests"
        echo "  -verbose.log  - Enable verbose mode and save output to verbose.log"
        echo ""
        ;;
esac
